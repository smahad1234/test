name: PR Dead Code Cleanup (Maven Multi-Module, No Extra Plugins)

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout PR branch
      - name: Checkout PR
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Set up Java 21
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      # 3Ô∏è‚É£ Cache Maven dependencies
      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # 4Ô∏è‚É£ Detect root POM
      - name: Find root POM
        id: rootpom
        run: |
          ROOT_POM=$(find . -name "pom.xml" -exec grep -l "<modules>" {} \; | head -n 1)
          if [ -z "$ROOT_POM" ]; then
            ROOT_POM=$(find . -name "pom.xml" | head -n 1)
          fi
          echo "ROOT_POM=$ROOT_POM" >> $GITHUB_ENV
          echo "Root POM detected: $ROOT_POM"

      # 5Ô∏è‚É£ Build and verify project
      - name: Build and verify
        run: mvn -f $ROOT_POM clean verify

      # 6Ô∏è‚É£ Analyze dependencies
      - name: Detect unused dependencies
        run: |
          mvn -f $ROOT_POM dependency:analyze | tee dependency-report.txt

      # 7Ô∏è‚É£ Prepare cleanup commit (if unused dependencies found)
      - name: Commit cleanup suggestions
        run: |
          UNUSED_LINES=$(grep "\[WARNING\] Unused declared dependencies found:" -A 10 dependency-report.txt || true)
          if [ -n "$UNUSED_LINES" ]; then
            echo "Unused dependencies detected:"
            echo "$UNUSED_LINES"
            git config user.name "github-actions"
            git config user.email "actions@github.com"
            git add pom.xml
            git diff-index --quiet HEAD || git commit -m "Cleanup: remove unused dependencies based on dependency:analyze"
            git push
            echo "Commit created with unused dependency cleanup suggestions."
          else
            echo "No unused dependencies detected."
          fi

      # 8Ô∏è‚É£ Comment dependency report on PR (safe version)
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('dependency-report.txt', 'utf8');

            const prNumber = context.payload.pull_request?.number;
            if (!prNumber) {
              console.log("No pull request number found. Skipping comment.");
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: "üìÑ Dead code / unused dependency analysis report:\n```\n" + report + "\n```"
              });
            }
