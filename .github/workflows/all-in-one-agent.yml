name: Dead Code Sweeper - Java PR (Robust)

on:
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:

jobs:
  dead-code-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build Java Project (safe)
        run: |
          if [ -f "mvnw" ]; then
            echo "Building with mvnw..."
            ./mvnw clean compile || echo "Build failed or skipped, continuing..."
          elif [ -f "pom.xml" ]; then
            echo "Building with Maven..."
            mvn clean compile || echo "Build failed or skipped, continuing..."
          else
            echo "No Maven project detected, skipping build"

      - name: Sweep Dead Java Code (safe)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          if [ -d "target/classes" ]; then
            echo "Scanning target/classes for potential dead code..."
            mkdir -p deadcode-report
            jdeps -verbose:class target/classes > deadcode-report/jdeps.txt
            DEAD=$(grep -E "->" deadcode-report/jdeps.txt | sort | uniq)

            if [ ! -z "$DEAD" ]; then
              echo "Potential dead Java code found, commenting on PR #$PR_NUMBER..."
              curl -s -X POST \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments" \
                -d "{\"body\":\"⚠️ Potential dead Java code detected:\\n\`\`\`\n$DEAD\n\`\`\`\"}"
            else
              echo "No dead Java code detected"
            fi
          else
            echo "target/classes directory not found, skipping dead code sweep"
