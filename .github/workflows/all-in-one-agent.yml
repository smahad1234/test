name: Cleanup Agent - PR Dead Code Reporter

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  dead-code-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Detect dead Python code
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          pip install vulture
          echo "=== Checking Python files ==="
          DEAD=$(vulture .)
          if [ ! -z "$DEAD" ]; then
            echo "Dead Python code found, commenting on PR..."
            curl -s -X POST \
                 -H "Authorization: token $GITHUB_TOKEN" \
                 -H "Accept: application/vnd.github.v3+json" \
                 "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments" \
                 -d "{\"body\":\"⚠️ Dead Python code detected:\\n\`\`\`\n$DEAD\n\`\`\`\"}"
          else
            echo "No dead Python code found"
          fi

      - name: Detect dead JS/TS code
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          npm install -g ts-prune
          echo "=== Checking JS/TS files ==="
          DEAD=$(ts-prune)
          if [ ! -z "$DEAD" ]; then
            echo "Dead JS/TS code found, commenting on PR..."
            curl -s -X POST \
                 -H "Authorization: token $GITHUB_TOKEN" \
                 -H "Accept: application/vnd.github.v3+json" \
                 "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments" \
                 -d "{\"body\":\"⚠️ Dead JS/TS code detected:\\n\`\`\`\n$DEAD\n\`\`\`\"}"
          else
            echo "No dead JS/TS code found"
          fi

      - name: Detect dead Java code
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          if [ -f "pom.xml" ]; then
            echo "=== Checking Java classes ==="
            mkdir -p deadcode-report
            jdeps -verbose:class target/classes > deadcode-report/jdeps.txt
            DEAD=$(grep -E "->" deadcode-report/jdeps.txt | sort | uniq)
            if [ ! -z "$DEAD" ]; then
              echo "Potential dead Java code found, commenting on PR..."
              curl -s -X POST \
                   -H "Authorization: token $GITHUB_TOKEN" \
                   -H "Accept: application/vnd.github.v3+json" \
                   "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments" \
                   -d "{\"body\":\"⚠️ Potential dead Java code detected:\\n\`\`\`\n$DEAD\n\`\`\`\"}"
            else
              echo "No dead Java code found"
            fi
          else
            echo "No Java project detected, skipping..."
