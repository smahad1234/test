name: Dead Code Sweeper - Java PR

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  dead-code-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          java-version: '17'

      - name: Build Java Project
        run: |
          if [ -f "mvnw" ]; then
            ./mvnw clean compile
          elif [ -f "pom.xml" ]; then
            mvn clean compile
          else
            echo "No Maven project detected, skipping build"

      - name: Sweep Dead Java Code on PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          if [ -d "target/classes" ]; then
            echo "Scanning target/classes for potential dead code..."
            mkdir -p deadcode-report
            jdeps -verbose:class target/classes > deadcode-report/jdeps.txt
            DEAD=$(grep -E "->" deadcode-report/jdeps.txt | sort | uniq)
            
            if [ ! -z "$DEAD" ]; then
              echo "Potential dead Java code found, commenting on PR #$PR_NUMBER..."
              curl -s -X POST \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments" \
                -d "{\"body\":\"⚠️ Potential dead Java code detected:\\n\`\`\`\n$DEAD\n\`\`\`\"}"
            else
              echo "No dead Java code detected"
            fi
          else
            echo "target/classes directory not found, skipping dead code sweep"
