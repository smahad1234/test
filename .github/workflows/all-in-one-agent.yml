name: Dead Code & Dependency Analyzer

permissions:
  contents: write
  issues: write
  pull-requests: write

on:
  pull_request:
    branches:
      - '**'

jobs:
  analysis:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    env:
      # Optional PAT for forked PRs
      PAT_TOKEN: ${{ secrets.PAT_TOKEN || '' }}

    steps:
      # 1Ô∏è‚É£ Checkout PR branch
      - name: Checkout PR
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Set up Java 21
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '21'

      # 3Ô∏è‚É£ Build all modules
      - name: Build all modules
        run: |
          for module in */; do
            if [ -f "$module/pom.xml" ]; then
              mvn -f "$module/pom.xml" clean compile --no-transfer-progress
            fi
          done

      # 4Ô∏è‚É£ Minimal dead code cleaner: remove empty Java files
      - name: Dead code cleaner
        id: deadcode
        run: |
          cleaned_count=0
          for dir in $(find . -type d -path "*/src/main/java"); do
            files=$(find "$dir" -type f -name "*.java" -empty)
            for f in $files; do
              rm "$f"
              echo "Removed empty file: $f"
              cleaned_count=$((cleaned_count + 1))
            done
          done
          echo "cleaned_count=$cleaned_count" >> $GITHUB_OUTPUT

      # 5Ô∏è‚É£ Run Maven dependency analysis
      - name: Run dependency analysis
        id: dep
        run: |
          mkdir -p dep-report
          for module in */; do
            if [ -f "$module/pom.xml" ]; then
              mvn -f "$module/pom.xml" dependency:analyze > dep-report/"${module%/}-dep.txt" || true
            fi
          done
          # Combine all reports into one string for GitHub Script
          dep_report=$(cat dep-report/*.txt)
          echo "dep_report<<EOF" >> $GITHUB_OUTPUT
          echo "$dep_report" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 6Ô∏è‚É£ Commit cleaned code if same-repo PR
      - name: Commit dead code changes
        if: github.event.pull_request.head.repo.full_name == github.repository
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          if ! git diff --cached --quiet; then
            git commit -m "chore: run Dead Code Cleaner"
            git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }} HEAD
          else
            echo "No changes to commit"

      # 7Ô∏è‚É£ Post combined report as PR comment
      - name: Post report as PR comment
        uses: actions/github-script@v7
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        with:
          github-token: ${{ env.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            if (!prNumber) {
              console.log("No PR number found, skipping comment.");
              return;
            }

            const cleaned = parseInt(process.env.cleaned_count || '0');
            const depReport = `\`\`\`\n${process.env.dep_report || 'No dependency report.'}\n\`\`\``;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `üìÑ **Dead Code & Dependency Analysis Report**\n\n- Removed **${cleaned} empty Java file(s)**\n- Maven dependency analysis:\n${depReport}`
            });
