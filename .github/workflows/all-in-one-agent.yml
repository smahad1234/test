name: Jakarta REST Integration Test Generator (Light)

on:
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:

jobs:
  generate-rest-tests:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Detect Changed Jakarta REST Files
        id: changed
        run: |
          git fetch origin ${{ github.base_ref }}
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '\.java$' || true)
          echo "changed=$CHANGED" >> $GITHUB_OUTPUT

      - name: Generate Integration Test Stubs
        if: steps.changed.outputs.changed != ''
        run: |
          mkdir -p generated-tests
          echo "${{ steps.changed.outputs.changed }}" | while read file; do
            [ -z "$file" ] && continue
            if grep -q "@Path" "$file"; then
              echo "Generating integration test for REST resource: $file"
              class=$(basename "$file" .java)
              testfile="generated-tests/${class}IT.java"

              # extract first @Path annotation (basic, lightweight)
              path=$(grep -m1 "@Path" "$file" | sed -E 's/.*@Path\("([^"]+)"\).*/\1/')
              [ -z "$path" ] && path="/${class,,}"

              cat <<EOF > "$testfile"
package generated;

import org.junit.jupiter.api.Test;
import java.net.*;
import java.io.*;

public class ${class}IT {

    private static final String BASE_URL = "http://localhost:8080${path}";

    @Test
    void test${class}Endpoint() throws Exception {
        HttpURLConnection conn = (HttpURLConnection) new URL(BASE_URL).openConnection();
        conn.setRequestMethod("GET");
        int code = conn.getResponseCode();
        System.out.println("Response code: " + code);
        assert(code == 200 || code == 404);
    }
}
EOF
            fi
          done

      - name: Commit & Push Generated Tests
        if: steps.changed.outputs.changed != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          mkdir -p src/test/java/generated
          cp -r generated-tests/* src/test/java/generated/ || true
          git add src/test/java/generated || true
          if git diff --cached --quiet; then
            echo "No new tests to commit."
          else
            git commit -m "ðŸ¤– Auto-generated Jakarta REST integration tests"
            git push origin HEAD:${{ github.head_ref }}
          fi
